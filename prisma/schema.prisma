// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  //output = "node_modules/@prisma/client"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Usuario {
  id         Int           @id @default(autoincrement())
  nome       String
  sobrenome  String        
  email      String        @unique
  senha      String
  role       String          @default("USER") // ADMIN_GERAL ou USER

  vinculos   VinculoEdicao[]
  autorias   Autoria[]
  atribuicoes Atribuicao[]
}

model VinculoEdicao {
  id        Int          @id @default(autoincrement())
  usuarioId Int
  edicaoId  Int
  tipo      String       // "CHAIR", "ADMIN_EVENTO", "REVISOR", "AUTOR"
  
  usuario   Usuario      @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  edicao    EdicaoEvento @relation(fields: [edicaoId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, edicaoId, tipo])
}

model Evento {
  id        Int            @id @default(autoincrement())
  sigla     String         @unique
  descricao String
  edicoes   EdicaoEvento[]
}

model EdicaoEvento {
  id        Int       @id @default(autoincrement())
  ano       Int
  eventoId  Int
  evento    Evento    @relation(fields: [eventoId], references: [id], onDelete: Cascade)
  
  vinculos  VinculoEdicao[]

  artigos   Artigo[]
  perguntas Pergunta[]

  @@unique([eventoId, ano])
}

model Artigo {
  id          Int          @id @default(autoincrement())
  titulo      String
  resumo      String
  pdfUrl      String?
  edicaoId    Int
  edicao      EdicaoEvento @relation(fields: [edicaoId], references: [id], onDelete: Cascade)

  // RELAÇÕES
  autores Autoria[] 
  atribuicoes Atribuicao[]
  areas ArtigoArea[]
}

model Area {
  id          Int          @id @default(autoincrement())
  nome        String       @unique

  artigos ArtigoArea[]
}

model ArtigoArea {
  artigoId    Int
  areaId      Int

  artigo      Artigo       @relation(fields: [artigoId], references: [id], onDelete: Cascade)
  area        Area         @relation(fields: [areaId], references: [id], onDelete: Cascade)

  @@id([artigoId, areaId])
}

model Autoria {
  id          Int          @id @default(autoincrement())
  artigoId    Int
  usuarioId   Int
  ordem       Int

  artigo      Artigo       @relation(fields: [artigoId], references: [id], onDelete: Cascade)
  usuario     Usuario      @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([artigoId, usuarioId])
}

model Atribuicao {
  id        Int        @id @default(autoincrement())
  artigoId  Int
  usuarioId Int
  artigo    Artigo     @relation(fields: [artigoId], references: [id], onDelete: Cascade)
  revisor   Usuario    @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  respostas Resposta[]

  @@unique([artigoId, usuarioId])
}

model Pergunta {
  id        Int        @id @default(autoincrement())
  texto     String
  tipo      String // Tipo da pergunta (ex: "texto", "escala", "multipla")
  edicaoId  Int
  edicao    EdicaoEvento @relation(fields: [edicaoId], references: [id], onDelete: Cascade)
  respostas Resposta[]
}

model Resposta {
  id           Int        @id @default(autoincrement())
  resposta     String
  atribuicaoId Int
  perguntaId   Int
  atribuicao   Atribuicao @relation(fields: [atribuicaoId], references: [id], onDelete: Cascade)
  pergunta     Pergunta   @relation(fields: [perguntaId], references: [id], onDelete: Cascade)

  @@unique([atribuicaoId, perguntaId])
}
